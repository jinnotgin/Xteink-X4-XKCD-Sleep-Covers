name: Build XKCD Sleep Pack

on:
  workflow_dispatch:
    inputs:
      n:
        description: "Number of images"
        required: true
        default: "100"
      workers:
        description: "Parallel download workers"
        required: true
        default: "8"
      rps:
        description: "Global requests/sec cap (politeness limit)"
        required: true
        default: "4"
      refresh_cache:
        description: "Rebuild cache (true/false)"
        required: true
        default: "false"
      create_release:
        description: "Create a GitHub release and attach the ZIP (true/false)"
        required: true
        default: "false"
  schedule:
    - cron: "0 3 * * 1"  # Mondays 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: write
    env:
      TZ: UTC

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Cache the script cache/ dir between runs to avoid rescanning/redownloading
      - name: Cache XKCD metadata/images
        uses: actions/cache@v4
        with:
          path: cache
          key: xkcd-cache-${{ runner.os }}-py311-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            xkcd-cache-${{ runner.os }}-py311-

      - name: Compute build vars
        id: vars
        shell: bash
        run: |
          # Defaults for scheduled runs (inputs are empty on schedule)
          N="${{ inputs.n }}"
          WORKERS="${{ inputs.workers }}"
          RPS="${{ inputs.rps }}"
          REFRESH="${{ inputs.refresh_cache }}"
          CREATE_RELEASE="${{ inputs.create_release }}"

          [ -z "$N" ] && N="100"
          [ -z "$WORKERS" ] && WORKERS="8"
          [ -z "$RPS" ] && RPS="4"
          [ -z "$REFRESH" ] && REFRESH="false"
          [ -z "$CREATE_RELEASE" ] && CREATE_RELEASE="false"

          DATE="$(date +%F)"  # YYYY-MM-DD
          ARTIFACT_NAME="xkcd_sleep_pack_n${N}_${DATE}"
          TAG="xkcd-sleep-pack-${DATE}-n${N}-run${GITHUB_RUN_NUMBER}"
          RELEASE_NAME="XKCD Sleep Pack ${DATE} (n=${N})"

          echo "n=$N" >> "$GITHUB_OUTPUT"
          echo "workers=$WORKERS" >> "$GITHUB_OUTPUT"
          echo "rps=$RPS" >> "$GITHUB_OUTPUT"
          echo "refresh=$REFRESH" >> "$GITHUB_OUTPUT"
          echo "create_release=$CREATE_RELEASE" >> "$GITHUB_OUTPUT"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "release_name=$RELEASE_NAME" >> "$GITHUB_OUTPUT"

      - name: Build pack
        run: |
          EXTRA=""
          if [ "${{ steps.vars.outputs.refresh }}" = "true" ]; then
            EXTRA="--refresh-cache"
          fi

          mkdir -p out/sleep

          python xkcd_sleep_pack.py \
            --out out/sleep \
            --n "${{ steps.vars.outputs.n }}" \
            --cache-dir ./cache \
            --workers "${{ steps.vars.outputs.workers }}" \
            --rps "${{ steps.vars.outputs.rps }}" \
            $EXTRA

      - name: Zip output
        run: |
          cd out
          zip -r "${{ steps.vars.outputs.artifact_name }}.zip" sleep

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.artifact_name }}
          path: out/${{ steps.vars.outputs.artifact_name }}.zip
          retention-days: 14

      - name: Create release (manual runs only)
        if: ${{ github.event_name == 'workflow_dispatch' && steps.vars.outputs.create_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.release_name }}
          body: |
            Automated build for XKCD Sleep Pack.
            Date (UTC): ${{ steps.vars.outputs.date }}
            Images: ${{ steps.vars.outputs.n }}
            Workers: ${{ steps.vars.outputs.workers }}
            Global RPS cap: ${{ steps.vars.outputs.rps }}
            Refresh cache: ${{ steps.vars.outputs.refresh }}
          files: out/${{ steps.vars.outputs.artifact_name }}.zip

      - name: Job summary
        run: |
          {
            echo "## XKCD Sleep Pack Build"
            echo ""
            echo "- Date (UTC): **${{ steps.vars.outputs.date }}**"
            echo "- Images: **${{ steps.vars.outputs.n }}**"
            echo "- Workers: **${{ steps.vars.outputs.workers }}**"
            echo "- Global RPS cap: **${{ steps.vars.outputs.rps }}**"
            echo "- Refresh cache: **${{ steps.vars.outputs.refresh }}**"
            echo "- Artifact: **${{ steps.vars.outputs.artifact_name }}.zip**"
            echo "- Create release: **${{ steps.vars.outputs.create_release }}**"
          } >> "$GITHUB_STEP_SUMMARY"
